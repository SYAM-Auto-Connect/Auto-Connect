<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">

    <title>Create New Post</title>
    <style>
        *{
            font-family: "Fantacy", Cop, Copperplate;

        }
    </style>
    <script th:src="@{/js/jquery.min.js}"></script>
    <script th:src="@{/js/key.js}"></script>
    <script>
        const url = 'https://car-data.p.rapidapi.com/cars/makes';
        const options = {
            method: 'GET',
            headers: {
                'X-RapidAPI-Key': API_KEY1,
                'X-RapidAPI-Host': 'car-data.p.rapidapi.com'
            }
        };
        async function fetchCarMakes() {
            try {
                const response = await fetch(url, options);
                const data = await response.json();
                console.log(data);
                populateMakeDropdown(data);
            } catch (error) {
                console.error(error);
            }
        }

        function populateMakeDropdown(makes) {
            const makeDropdown = document.getElementById('make-dropdown');
            makeDropdown.innerHTML = '';

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.text = 'Select Make';
            makeDropdown.appendChild(defaultOption);

            makes.sort();

            makes.forEach(function(make) {
                const option = document.createElement('option');
                option.value = make;
                option.text = make;
                makeDropdown.appendChild(option);
            });
        }


        function fetchCarModels(make) {
            const url = `https://car-data.p.rapidapi.com/cars?limit=50&page=1&make=` + make;
            const headers = {
                'X-RapidAPI-Key': API_KEY1,
                'X-RapidAPI-Host': 'car-data.p.rapidapi.com'
            };

            let allModels = [];

            function fetchAllModels(url) {
                $.ajax({
                    method: 'GET',
                    url: url,
                    headers: headers,
                    contentType: 'application/json',
                    success: function(result) {
                        console.log(result);
                        allModels = allModels.concat(result);

                        const nextPage = result.meta && result.meta.next;

                        if (nextPage) {
                            fetchAllModels(nextPage);
                        } else {
                            populateModelDropdown(allModels);
                        }
                    },
                    error: function(jqXHR) {
                        console.error('Error: ', jqXHR.responseText);
                    }
                });
            }

            fetchAllModels(url);
        }


        function populateModelDropdown(models) {
            const modelDropdown = document.getElementById('model-dropdown');
            modelDropdown.innerHTML = '';

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.text = 'Select Model';
            modelDropdown.appendChild(defaultOption);

            const uniqueModels = [];
            const modelNames = new Set();

            models.forEach(function (car) {
                if (!modelNames.has(car.model)) {
                    uniqueModels.push(car);
                    modelNames.add(car.model);
                }
            });

            uniqueModels.sort(function (a, b) {
                return a.model.toLowerCase().localeCompare(b.model.toLowerCase());
            });

            uniqueModels.forEach(function (car) {
                const option = document.createElement('option');
                option.value = car.model;
                option.text = capitalizeFirstLetter(car.model);
                modelDropdown.appendChild(option);
            });
        }

        function capitalizeFirstLetter(str) {
            return str.replace(/\b\w/g, function (match) {
                return match.toUpperCase();
            });
        }

        fetchCarMakes();
    </script>
    <style>
        textarea.form-control {
            background-color: #eee;
            border-radius: 10px;
        }
        .img-fluid{
            height:100%;
        }
    </style>

</head>
<body>
<nav th:replace="~{partials/navbar :: navbar}"></nav>

<h1>Create New Post</h1>
<form th:action="@{/posts/create}" th:object="${post}" th:method="post" class="row">
    <div class="col-md-6">
        <div class="form-group">
            <label for="title">Title:</label>
            <input type="text" name="title" id="title" th:field="*{title}" class="form-control">
        </div>
        <div class="form-group">
            <label for="body">Describe your situation:</label>
            <textarea name="body" id="body" th:field="*{body}" class="form-control"></textarea>
        </div>
        <div class="form-group">
            <label for="make-dropdown">Select Make:</label>
            <select id="make-dropdown" onchange="fetchCarModels(this.value.toLowerCase());" th:field="*{car_make}" class="form-control">
                <option value="">Select Make</option>
            </select>
        </div>
        <div class="form-group">
            <label for="model-dropdown">Select Model:</label>
            <select id="model-dropdown" class="form-control" th:field="*{car_body}">
                <option value="">Select Model</option>
            </select>
        </div>
        <div class="form-group">
            <label for="car_year">Car Year:</label>
            <input type="text" name="car_year" id="car_year" th:field="*{car_year}" class="form-control">
        </div>
        <div class="form-group">
            <button type="submit" class="btn btn-primary">Create Post</button>
        </div>
    </div>
    <div class="col-md-6">
        <img src="/img/home-image.jpg" class="img-fluid" alt="Home Image">
    </div>

</form>

</body>
</html>
