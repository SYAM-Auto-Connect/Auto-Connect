<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Instant Messaging</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <style>
        * {
            font-family: "Fantacy", Cop, Copperplate;
            list-style: none;

        }

        .navbar {
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            font-weight: bold;
        }

        .navbar .nav-item .nav-link {
            color: #555;
        }

        .navbar .nav-item .nav-link:hover {
            color: #007BFF;
        }

        .navbar .btn {
            color: #007BFF;
            border-color: #007BFF;
        }

        .navbar .btn:hover {
            color: #fff;
            background-color: #007BFF;
        }

        .recipient-message {
            background-color: #f0f0f0;
            color: #333;
            padding: 5px 10px;
            border-radius: 10px;
            display: flex;
            margin-bottom: 5px;
            text-align: left;
            margin-left: auto;
            margin-right: 25%;
        }

        .sender-message {
            background-color: #007BFF;
            color: #fff;
            padding: 5px 10px;
            border-radius: 10px;
            display: flex;
            margin-bottom: 5px;
            margin-right: auto;
            margin-left: 25%;
            text-align: right;
        }

        .new-conversation-form {
            display: inline;
            text-align: right;
        }

        .existing-conversation-form {
            margin-left: 50%;
        }

        .existing-conversation {
            width: 60%;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            margin-left: auto;
            margin-right: 5%;
            position: relative;
            align-content: flex-end;
        }

        .messageForm {
            width: 60%;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            margin-left: auto;
            margin-right: 5%;
            height: 100%;
        }

        .conversation-card {
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .render {
            position: sticky;
            top: 0;
            width: 25%;
            background-color: white;
            text-align: left;
            padding: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<nav th:replace="~{partials/navbar :: navbar}"></nav>
<h1>Instant Messaging</h1>
<!-- Search form -->
<form th:action="@{/messages/search}" method="get" id="searchForm">
    <input type="text" name="keyword" placeholder="Search by first name, last name, or username">
    <button type="submit">Search</button>
</form>
<!-- Search Results -->
<div id="searchResults" th:if="${searchAttempted}">
    <h2>Search Results:</h2>
    <ul>
        <li th:each="result : ${searchResults}">

            <button class="send-message-btn"><span th:text="${result.username}"></span>: Contact</button>
            <!-- Message form -->
            <div class="messageForm" style="display: none;">
                <h2>Start Connecting</h2>
                <form th:action="@{/messages/new-conversation}" method="post" class="new-conversation-form">
                    <input type="hidden" name="recipientId" th:value="${result.id}">
                    <input type="text" name="newMessage" placeholder="Enter your message" style="width: 80%">
                    <button type="submit">Send</button>
                </form>
            </div>
        </li>
    </ul>
    <!-- Render "No results" message if searchResults is empty -->
    <p th:if="${#lists.isEmpty(searchResults)}">No results</p>
</div>

<!-- Display existing conversations -->
<div id="existingConversations">
    <h2>Existing Conversations:</h2>
    <ul>
        <li th:each="conversation : ${conversations}" class="conversation-card"
            th:data-conversation-id="${conversation.id}">
            <div class="conversationButton">
                <button th:if="${conversation.user1.id == #authentication.principal.id}"
                        th:text="${conversation.user2.username}" class="render"></button>
                <button th:if="${conversation.user2.id == #authentication.principal.id}"
                        th:text="${conversation.user1.username}" class="render"></button>
            </div>
            <!-- Display previous messages -->
            <div class="existing-conversation" style="display: none;">
                <ul>
                    <li th:each="message : ${conversation.messages}">
        <span th:class="${message.sender.id == #authentication.principal.id} ? 'sender-message' : 'recipient-message'"
              th:text="${(message.sender.id == #authentication.principal.id) ? 'You' : conversation.user2.id == #authentication.principal.id ? conversation.user1.username : conversation.user2.username} + ': ' + ${message.message}">
        </span>
                    </li>
                </ul>
                <form th:action="@{/messages/send}" method="post" class="existing-conversation-form">
                    <input th:if="${conversation.user1.id == #authentication.principal.id}" type="hidden"
                           name="recipientId"
                           th:value="${conversation.user2.id}"/>
                    <input th:if="${conversation.user2.id == #authentication.principal.id}" type="hidden"
                           name="recipientId"
                           th:value="${conversation.user1.id}"/>
                    <input type="hidden" name="conversationId" th:value="${conversation.id}"/>
                    <input type="text" name="message" placeholder="Enter your message"/>
                    <button type="submit">Send</button>
                </form>
            </div>
        </li>
    </ul>
    <!-- Render "No conversations" message if conversations is empty -->
    <p th:if="${#lists.isEmpty(conversations)}">No conversations</p>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Toggle message form visibility for search results
        var sendMessageButtons = document.querySelectorAll("#searchResults .send-message-btn");
        sendMessageButtons.forEach(function (button) {
            button.addEventListener("click", function (event) {
                event.preventDefault();
                var messageForm = this.nextElementSibling;
                messageForm.style.display = (messageForm.style.display === "none") ? "block" : "none";
            });
        });
        // Show/hide existing conversation when the "render" button is clicked
        var renderButtons = document.querySelectorAll("#existingConversations .render");
        renderButtons.forEach(function (button) {
            button.addEventListener("click", function () {
                var conversationCard = this.closest(".conversation-card");
                var existingConversation = conversationCard.querySelector(".existing-conversation");

                // Hide all existing conversations
                var allExistingConversations = document.querySelectorAll(".existing-conversation");
                allExistingConversations.forEach(function (conversation) {
                    conversation.style.display = "none";
                });

                existingConversation.style.display = "block";

                // Scroll to the top of the conversation
                // existingConversation.scrollTop = 0;
            });
        });
    });
</script>

</body>
</html>
