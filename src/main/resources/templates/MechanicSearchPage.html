<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>

    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet'/>
    <script th:src="@{/js/keys.js}"></script>
    <meta charset="UTF-8">
    <title>Mechanic Search Page</title>

    <style>
        #map {
            height: 400px;
            width: 100%;
        }
    </style>
</head>

<body>


<div id='map' style='width: 400px; height: 300px;'></div>
<script>
    mapboxgl.accessToken = "pk.eyJ1IjoiYW1pcjk3MyIsImEiOiJjbGo0aTdsZ2IwMWhhM3RwaTJ3OW55dThwIn0.aHk5duLxybjEOkw0_BDHCA"
    const map = new mapboxgl.Map({
        container: 'map', // container ID
        style: 'mapbox://styles/mapbox/streets-v12', // style URL
        center: [-96.808891, 32.779167], // starting position [lng, lat]
        zoom: 9, // starting zoom
    });

    // const mechanics = [
    //      th:each="mechanic : ${ViewAllMechanics}"
    //     {
    //         name: "${mechanic.first_name + ' ' + mechanic.last_name}",
    //         address_street: "${mechanic.address_street}",
    //         address_city: "${mechanic.address_city}",
    //         address_zip: "${mechanic.address_zip}"
    //     }
    //
    // ];

    // function listOfMechanics() {
    //
    //     fetch('http://localhost:8080/users/mechanic-list')
    //         .then((response) => response.json())
    //         .then((response) => {
    //             // console.log(response)
    //
    //             response.forEach(mechanic => {
    //                 let firstName =mechanic.first_name
    //                 let lasName = mechanic.last_name
    //                 let street = mechanic.address_street
    //                 let city = mechanic.address_city
    //                 let zipCode = mechanic.address_zip
    //
    //                     new mapboxgl.Marker()
    //                         .setLngLat([-96.808891, 32.779167]) // Set the marker position using mechanic's coordinates
    //                         .setPopup(new mapboxgl.Popup().setHTML(popupContent))
    //                         .addTo(map);
    //             })
    //         })
    // }
    //
    // listOfMechanics();

    function listOfMechanics() {
        fetch('http://localhost:8080/users/mechanic-list')
            .then((response) => response.json())
            .then((response) => {
                response.forEach(mechanic => {
                    let firstName = mechanic.first_name;
                    let lastName = mechanic.last_name;
                    let street = mechanic.address_street;
                    let city = mechanic.address_city;
                    let zipCode = mechanic.address_zip;

                    // Construct the search query for geocoding
                    let searchQuery = `${street}, ${city}, ${zipCode}`;

                    // Perform forward geocoding request
                    fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(searchQuery)}.json?access_token=pk.eyJ1IjoiYW1pcjk3MyIsImEiOiJjbGo0aTdsZ2IwMWhhM3RwaTJ3OW55dThwIn0.aHk5duLxybjEOkw0_BDHCA`)
                        .then((geocodeResponse) => geocodeResponse.json())
                        .then((geocodeResponse) => {

                            let coordinates = geocodeResponse.features[0].center;


                            new mapboxgl.Marker()
                                .setLngLat(coordinates)
                                .setPopup(new mapboxgl.Popup().setHTML(getPopupContent(firstName, lastName, street, city, zipCode)))
                                .addTo(map);
                        })
                        .catch((error) => {
                            console.error('Error performing geocoding request:', error);
                        });
                });
            })
            .catch((error) => {
                console.error('Error retrieving mechanic list:', error);
            });
    }

    function getPopupContent(firstName, lastName, street, city, zipCode) {
        return `
        <h3>${firstName} ${lastName}</h3>
        <p>${street}, ${city}, ${zipCode}</p>

    `;
    }

    listOfMechanics();






    // mechanics.forEach(mechanic => {
    //     const popupContent = `<strong>${mechanic.name}</strong><br>${mechanic.address_street}, ${mechanic.address_city} ${mechanic.address_zip}`;
    //     console.log(mechanic.name)
    //     new mapboxgl.Marker()
    //         .setLngLat([-96.808891, 32.779167]) // Set the marker position using mechanic's coordinates
    //         .setPopup(new mapboxgl.Popup().setHTML(popupContent))
    //         .addTo(map);
    // });



</script>
<h1>All Mechanics</h1>
<table>
    <thead>
    <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Address</th>
    </tr>
    </thead>
    <tbody>



    <h1>Mechanic Search</h1>

    <form th:action="@{/MechanicSearchPage}" method="get">
        <input type="text" name="keyword" placeholder="Enter keyword">
        <button type="submit">Search</button>
    </form>

    <h2>Search Results</h2>
    <table>
        <thead>
        <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Address</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="mechanic : ${searchResults}">
            <td th:text="${mechanic.first_name + ' ' + mechanic.last_name}"></td>
            <td th:text="${mechanic.email}"></td>
            <td th:text="${mechanic.address_street + ', ' + mechanic.address_city + ' ' + mechanic.address_zip}"></td>
        </tr>
        </tbody>
    </table>


    <h1>All Mechanics</h1>
    <table>
        <thead>
        <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Address</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="mechanic : ${ViewAllMechanics}">
            <td th:text="${mechanic.first_name + ' ' + mechanic.last_name}"></td>
            <td th:text="${mechanic.email}"></td>
            <td th:text="${mechanic.address_street + ', ' + mechanic.address_city + ' ' + mechanic.address_zip}"></td>
        </tr>
        </tbody>
    </table>
</table>
</body>
</html>
